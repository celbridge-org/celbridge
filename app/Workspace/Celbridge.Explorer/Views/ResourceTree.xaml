<UserControl
  x:Class="Celbridge.Explorer.Views.ResourceTree"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:local="using:Celbridge.Explorer.Views"
  xmlns:localControls="using:Celbridge.Explorer.Views.Controls"
  xmlns:models="using:Celbridge.Explorer.Models"
  xmlns:controls="using:Celbridge.UserInterface.Views.Controls"
  xmlns:converters="using:Celbridge.UserInterface.Converters"
  DataContext="{x:Bind ViewModel}"
  Background="{ThemeResource ApplicationBackgroundBrush}">

  <UserControl.Resources>
    <!-- MenuFlyout for context menu -->
    <MenuFlyout x:Name="ResourceContextMenu"/>

    <!-- Item template for the ListView -->
    <DataTemplate x:Key="TreeListItemTemplate"
                  x:DataType="models:ResourceViewItem">
      <Grid Margin="{x:Bind IndentMargin}"
            Padding="8,0,0,0"
            MinHeight="32"
            Background="{ThemeResource SubtleFillColorTransparentBrush}">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="32"/>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Tooltip for root folder -->
        <ToolTipService.ToolTip>
          <ToolTip Visibility="{x:Bind IsRootFolder}">
            <TextBlock Text="Double-click to open in File Explorer"/>
          </ToolTip>
        </ToolTipService.ToolTip>

        <!-- Expand/Collapse chevron button (hidden for root folder) -->
        <Button Grid.Column="0"
                Click="ExpanderButton_Click"
                Visibility="{x:Bind ChevronVisibility}"
                Style="{StaticResource TreeExpanderButtonStyle}">
          <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}"
                    Glyph="{x:Bind IsExpanded, Mode=OneWay, Converter={StaticResource ExpanderGlyphConverter}}"
                    FontSize="12"/>
        </Button>

        <!-- Resource icon -->
        <localControls:ResourceIcon Grid.Column="1"
                                    Resource="{x:Bind Resource}"
                                    Margin="-2,0,12,0"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="Left" />

        <!-- Resource name (semi-bold for root folder) -->
        <TextBlock Grid.Column="2"
                   Text="{x:Bind Name}"
                   VerticalAlignment="Center"
                   TextTrimming="CharacterEllipsis"
                   FontWeight="{x:Bind IsRootFolder, Converter={StaticResource RootFolderFontWeightConverter}}" />
      </Grid>
    </DataTemplate>

    <!-- Style for the expander button -->
    <Style x:Key="TreeExpanderButtonStyle" TargetType="Button">
      <Setter Property="Background" Value="Transparent"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="Padding" Value="0"/>
      <Setter Property="Width" Value="32"/>
      <Setter Property="Height" Value="32"/>
      <Setter Property="HorizontalAlignment" Value="Left"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="Button">
            <Grid Background="Transparent">
              <ContentPresenter HorizontalAlignment="Center" 
                              VerticalAlignment="Center"/>
            </Grid>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>

    <!-- Converters -->
    <converters:ExpanderGlyphConverter x:Key="ExpanderGlyphConverter"/>
    <converters:BoolToFontWeightConverter x:Key="RootFolderFontWeightConverter"/>
  </UserControl.Resources>

  <!-- Resource List View styled as a tree -->
  <ListView x:Name="ResourceListView"
            ItemsSource="{x:Bind ViewModel.TreeItems, Mode=OneWay}"
            ItemTemplate="{StaticResource TreeListItemTemplate}"
            SelectionMode="Extended"
            SelectedItem="{x:Bind ViewModel.SelectedItem, Mode=TwoWay}"
            CanDragItems="True"
            AllowDrop="True"
            CanReorderItems="False"
            IsDoubleTapEnabled="True"
            DoubleTapped="ListView_DoubleTapped"
            RightTapped="ListView_RightTapped"
            KeyDown="ListView_KeyDown"
            Tapped="ListView_Tapped"
            DragItemsStarting="ListView_DragItemsStarting"
            DragOver="ListView_DragOver"
            Drop="ListView_Drop"
            SelectionChanged="ListView_SelectionChanged"
            TabNavigation="Once"
            IsTabStop="True">
    
    <ListView.ItemContainerStyle>
      <Style TargetType="ListViewItem">
        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
        <Setter Property="Padding" Value="0"/>
        <Setter Property="Margin" Value="0"/>
        <Setter Property="MinHeight" Value="32"/>
        <Setter Property="Template">
          <Setter.Value>
            <ControlTemplate TargetType="ListViewItem">
              <Grid x:Name="ContentGrid"
                    Padding="{TemplateBinding Padding}"
                    Background="Transparent">
                <ContentPresenter/>
                
                <VisualStateManager.VisualStateGroups>
                  <VisualStateGroup x:Name="CommonStates">
                    <!-- Normal state -->
                    <VisualState x:Name="Normal"/>
                    
                    <!-- Pointer over state -->
                    <VisualState x:Name="PointerOver">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource SubtleFillColorSecondaryBrush}"/>
                      </VisualState.Setters>
                    </VisualState>
                    
                    <!-- Pressed state -->
                    <VisualState x:Name="Pressed">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource SubtleFillColorTertiaryBrush}"/>
                      </VisualState.Setters>
                    </VisualState>
                    
                    <!-- Selected state - full row accent background -->
                    <VisualState x:Name="Selected">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource ListItemSelectedBackgroundBrush}"/>
                      </VisualState.Setters>
                    </VisualState>
                    
                    <!-- Selected + PointerOver state -->
                    <VisualState x:Name="SelectedPointerOver">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource ListItemSelectedBackgroundBrush}"/>
                      </VisualState.Setters>
                    </VisualState>
                    
                    <!-- Selected + Pressed state -->
                    <VisualState x:Name="SelectedPressed">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource ListItemSelectedBackgroundBrush}"/>
                      </VisualState.Setters>
                    </VisualState>
                  </VisualStateGroup>
                </VisualStateManager.VisualStateGroups>
              </Grid>
            </ControlTemplate>
          </Setter.Value>
        </Setter>
      </Style>
    </ListView.ItemContainerStyle>
  </ListView>
</UserControl>
