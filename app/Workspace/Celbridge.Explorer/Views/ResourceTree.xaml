<UserControl
x:Class="Celbridge.Explorer.Views.ResourceTree"
xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
xmlns:local="using:Celbridge.Explorer.Views"
xmlns:localControls="using:Celbridge.Explorer.Views.Controls"
xmlns:models="using:Celbridge.Explorer.Models"
xmlns:controls="using:Celbridge.UserInterface.Views.Controls"
DataContext="{x:Bind ViewModel}"
Background="{ThemeResource ApplicationBackgroundBrush}">

  <UserControl.Resources>
    <MenuFlyout x:Name="ResourceContextMenu"
                Placement="RightEdgeAlignedTop"
                Opening="ResourceContextMenu_Opening">
      <!-- Single-item only operations -->
      <MenuFlyoutItem Text="{x:Bind RunString}"
                      Click="ResourceContextMenu_Run"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"
                      IsEnabled="{x:Bind ViewModel.IsExecutableResourceSelected, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind OpenString}"
                      Click="ResourceContextMenu_Open"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"
                      IsEnabled="{x:Bind ViewModel.IsDocumentResourceSelected, Mode=OneWay}" />

      <MenuFlyoutItem Text="{x:Bind AddFileString}"
                      Icon="Page2"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"
                      Click="ResourceContextMenu_AddFile">
      </MenuFlyoutItem>

      <MenuFlyoutItem Text="{x:Bind AddFolderString}"
                      Icon="Folder"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"
                      Click="ResourceContextMenu_AddFolder">
      </MenuFlyoutItem>
      <MenuFlyoutSeparator />
      <!-- Multi-select enabled operations -->
      <MenuFlyoutItem Text="{x:Bind CutString}"
                      Icon="Cut"
                      Click="ResourceContextMenu_Cut"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind CopyString}"
                      Icon="Copy"
                      Click="ResourceContextMenu_Copy"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind PasteString}"
                      Icon="Paste"
                      Click="ResourceContextMenu_Paste"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"
                      IsEnabled="{x:Bind ViewModel.IsResourceOnClipboard, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind DeleteString}"
                      Icon="Delete"
                      Click="ResourceContextMenu_Delete"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <!-- Single-item only operations -->
      <MenuFlyoutItem Text="{x:Bind RenameString}"
                      Icon="Edit"
                      Click="ResourceContextMenu_Rename"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <MenuFlyoutSeparator />
      <MenuFlyoutItem Text="{x:Bind CopyResourceKeyString}"
                      Click="ResourceContextMenu_CopyResourceKey"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind CopyFilePathString}"
                      Click="ResourceContextMenu_CopyFilePath"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <MenuFlyoutSeparator />
      <MenuFlyoutItem Text="{x:Bind OpenFileExplorerString}"
                      Click="ResourceContextMenu_OpenFileExplorer"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"/>
      <MenuFlyoutItem Text="{x:Bind OpenApplicationString}"
                      Click="ResourceContextMenu_OpenApplication"
                      Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay}"
                      IsEnabled="{x:Bind ViewModel.IsFileResourceSelected, Mode=OneWay}"/>
    </MenuFlyout>

    <!-- Item template for the ListView -->
    <DataTemplate x:Key="TreeListItemTemplate"
                  x:DataType="models:ResourceViewItem">
      <Grid Margin="{x:Bind IndentMargin}"
            Padding="8,0,0,0"
            MinHeight="32"
            Background="{ThemeResource SubtleFillColorTransparentBrush}">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="32"/>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Expand/Collapse chevron button -->
        <Button Grid.Column="0"
                Click="ExpanderButton_Click"
                Visibility="{x:Bind HasChildren}"
                Style="{StaticResource TreeExpanderButtonStyle}">
          <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}"
                    Glyph="{x:Bind IsExpanded, Mode=OneWay, Converter={StaticResource ExpanderGlyphConverter}}"
                    FontSize="12"/>
        </Button>

        <!-- Resource icon -->
        <localControls:ResourceIcon Grid.Column="1"
                                    Resource="{x:Bind Resource}"
                                    Margin="-2,0,12,0"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="Left" />

        <!-- Resource name -->
        <TextBlock Grid.Column="2"
                   Text="{x:Bind Name}"
                   VerticalAlignment="Center"
                   TextTrimming="CharacterEllipsis" />
      </Grid>
    </DataTemplate>

    <!-- Style for the expander button -->
    <Style x:Key="TreeExpanderButtonStyle" TargetType="Button">
      <Setter Property="Background" Value="Transparent"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="Padding" Value="0"/>
      <Setter Property="Width" Value="32"/>
      <Setter Property="Height" Value="32"/>
      <Setter Property="HorizontalAlignment" Value="Left"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="Button">
            <Grid Background="Transparent">
              <ContentPresenter HorizontalAlignment="Center" 
                              VerticalAlignment="Center"/>
            </Grid>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>

    <!-- Converter for expand/collapse glyph -->
    <local:ExpanderGlyphConverter x:Key="ExpanderGlyphConverter"/>
  </UserControl.Resources>

  <!-- Resource List View styled as a tree -->
  <ListView x:Name="ResourceListView"
            ItemsSource="{x:Bind ViewModel.TreeItems, Mode=OneWay}"
            ItemTemplate="{StaticResource TreeListItemTemplate}"
            SelectionMode="Extended"
            SelectedItem="{x:Bind ViewModel.SelectedItem, Mode=TwoWay}"
            CanDragItems="True"
            AllowDrop="True"
            CanReorderItems="False"
            IsDoubleTapEnabled="True"
            DoubleTapped="ListView_DoubleTapped"
            RightTapped="ListView_RightTapped"
            KeyDown="ListView_KeyDown"
            DragItemsStarting="ListView_DragItemsStarting"
            DragOver="ListView_DragOver"
            Drop="ListView_Drop"
            SelectionChanged="ListView_SelectionChanged"
            ContextFlyout="{StaticResource ResourceContextMenu}"
            TabNavigation="Once"
            IsTabStop="True">
    <ListView.ItemContainerStyle>
      <Style TargetType="ListViewItem">
        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
        <Setter Property="Padding" Value="0,0,0,0"/>
        <Setter Property="Margin" Value="0"/>
        <Setter Property="MinHeight" Value="32"/>
        <Setter Property="Template">
          <Setter.Value>
            <ControlTemplate TargetType="ListViewItem">
              <Grid>
                <!-- Item content with background -->
                <Grid x:Name="ContentGrid"
                      Padding="{TemplateBinding Padding}"
                      Background="Transparent">
                  <ContentPresenter/>
                </Grid>

                <!-- Selection indicator bar -->
                <Border x:Name="SelectionIndicator"
                        Width="3"
                        Height="16"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        Margin="6,0,0,0"
                        CornerRadius="1.5"
                        Background="{ThemeResource AccentFillColorDefaultBrush}"
                        Opacity="0"/>
                
                <VisualStateManager.VisualStateGroups>
                  <VisualStateGroup x:Name="CommonStates">
                    <!-- Normal state -->
                    <VisualState x:Name="Normal"/>
                    
                    <!-- Pointer over state -->
                    <VisualState x:Name="PointerOver">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource SubtleFillColorSecondaryBrush}"/>
                      </VisualState.Setters>
                    </VisualState>
                    
                    <!-- Pressed state -->
                    <VisualState x:Name="Pressed">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource SubtleFillColorTertiaryBrush}"/>
                      </VisualState.Setters>
                    </VisualState>
                    
                    <!-- Selected state -->
                    <VisualState x:Name="Selected">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource SubtleFillColorSecondaryBrush}"/>
                        <Setter Target="SelectionIndicator.Opacity" Value="1"/>
                      </VisualState.Setters>
                    </VisualState>
                    
                    <!-- Selected + PointerOver state -->
                    <VisualState x:Name="SelectedPointerOver">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource SubtleFillColorSecondaryBrush}"/>
                        <Setter Target="SelectionIndicator.Opacity" Value="1"/>
                      </VisualState.Setters>
                    </VisualState>
                    
                    <!-- Selected + Pressed state -->
                    <VisualState x:Name="SelectedPressed">
                      <VisualState.Setters>
                        <Setter Target="ContentGrid.Background" Value="{ThemeResource SubtleFillColorTertiaryBrush}"/>
                        <Setter Target="SelectionIndicator.Opacity" Value="1"/>
                      </VisualState.Setters>
                    </VisualState>
                  </VisualStateGroup>
                </VisualStateManager.VisualStateGroups>
              </Grid>
            </ControlTemplate>
          </Setter.Value>
        </Setter>
      </Style>
    </ListView.ItemContainerStyle>
  </ListView>
</UserControl>
