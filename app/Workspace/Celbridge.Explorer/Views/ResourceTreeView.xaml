<UserControl
    x:Class="Celbridge.Explorer.Views.ResourceTreeView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Celbridge.Explorer.Views"
    xmlns:explorer="using:Celbridge.Explorer"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:models="using:Celbridge.Explorer.Models"
    xmlns:ui="using:Celbridge.UserInterface.Services"
    mc:Ignorable="d"
    DataContext="{x:Bind ViewModel}"
    Background="{ThemeResource ApplicationBackgroundBrush}">

  <UserControl.Resources>
    <!-- Storyboard animations for toolbar fade in/out -->
    <Storyboard x:Name="ToolbarFadeIn">
      <DoubleAnimation Storyboard.TargetName="ToolbarPanel"
                       Storyboard.TargetProperty="Opacity"
                       To="1"
                       Duration="0:0:0.15" />
    </Storyboard>
    <Storyboard x:Name="ToolbarFadeOut">
      <DoubleAnimation Storyboard.TargetName="ToolbarPanel"
                       Storyboard.TargetProperty="Opacity"
                       To="0"
                       Duration="0:0:0.15" />
    </Storyboard>

    <MenuFlyout x:Name="ResourceContextMenu"
                Placement="RightEdgeAlignedTop"
                Opening="ResourceContextMenu_Opening">
      <MenuFlyoutItem Text="{x:Bind RunString}"
                      Click="ResourceContextMenu_Run"
                      IsEnabled="{x:Bind ViewModel.IsExecutableResourceSelected, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind OpenString}"
                      Click="ResourceContextMenu_Open"
                      IsEnabled="{x:Bind ViewModel.IsDocumentResourceSelected, Mode=OneWay}" />
      <MenuFlyoutSubItem Text="{x:Bind AddString}">
        <MenuFlyoutSubItem.Icon>
          <SymbolIcon Symbol="Add" />
        </MenuFlyoutSubItem.Icon>
        <MenuFlyoutItem Text="{x:Bind FolderString}"
                        Icon="Folder"
                        Click="ResourceContextMenu_AddFolder" />
        <MenuFlyoutItem Text="{x:Bind AddPythonScriptString}"
                        Tag="{x:Bind explorer:ResourceFormat.Python}"
                        Click="ResourceContextMenu_AddFile" />
        <MenuFlyoutItem Text="{x:Bind AddExcelString}"
                        Tag="{x:Bind explorer:ResourceFormat.Excel}"
                        Click="ResourceContextMenu_AddFile" />
        <MenuFlyoutItem Text="{x:Bind AddMarkdownString}"
                        Tag="{x:Bind explorer:ResourceFormat.Markdown}"
                        Click="ResourceContextMenu_AddFile" />
        <MenuFlyoutItem Text="{x:Bind AddWebAppString}"
                        Tag="{x:Bind explorer:ResourceFormat.WebApp}"
                        Click="ResourceContextMenu_AddFile" />
        <MenuFlyoutItem Text="{x:Bind AddTextFileString}"
                        Tag="{x:Bind explorer:ResourceFormat.Text}"
                        Click="ResourceContextMenu_AddFile" />        
      </MenuFlyoutSubItem>
      <MenuFlyoutSeparator />
      <MenuFlyoutItem Text="{x:Bind CutString}"
                      Icon="Cut"
                      Click="ResourceContextMenu_Cut"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind CopyString}"
                      Icon="Copy"
                      Click="ResourceContextMenu_Copy"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind PasteString}"
                      Icon="Paste"
                      Click="ResourceContextMenu_Paste"
                      IsEnabled="{x:Bind ViewModel.IsResourceOnClipboard, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind DeleteString}"
                      Icon="Delete"
                      Click="ResourceContextMenu_Delete"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <MenuFlyoutItem Text="{x:Bind RenameString}"
                      Icon="Edit"
                      Click="ResourceContextMenu_Rename"
                      IsEnabled="{x:Bind ViewModel.IsResourceSelected, Mode=OneWay}" />
      <MenuFlyoutSeparator />
      <MenuFlyoutItem Text="{x:Bind OpenFileExplorerString}"
                      Click="ResourceContextMenu_OpenFileExplorer"/>
      <MenuFlyoutItem Text="{x:Bind OpenApplicationString}"
                      Click="ResourceContextMenu_OpenApplication"/>
    </MenuFlyout>

    <DataTemplate x:Key="FolderTemplate"
                  x:DataType="muxc:TreeViewNode">
      <muxc:TreeViewItem ContextFlyout="{StaticResource ResourceContextMenu}"
                         DoubleTapped="TreeViewItem_DoubleTapped">
        <StackPanel Orientation="Horizontal">
          <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}"
                    Glyph="&#xE8D5;"
                    FontSize="16"
                    Margin="0 4 6 0"
                    VerticalAlignment="Center"
                    Foreground="#FFCC40" />
          <TextBlock Margin="0"
                     VerticalAlignment="Center"
                     Text="{Binding Path=Content.Name, Mode=OneWay}" />
        </StackPanel>
      </muxc:TreeViewItem>
    </DataTemplate>

    <DataTemplate x:Key="FileTemplate"
                  x:DataType="muxc:TreeViewNode">
      <muxc:TreeViewItem ContextFlyout="{StaticResource ResourceContextMenu}"
                         DoubleTapped="TreeViewItem_DoubleTapped">
        <StackPanel Orientation="Horizontal">
          <FontIcon FontFamily="{Binding Content.Icon.FontFamily, Converter={StaticResource FontFamilyConverter}}"
                    Glyph="{Binding Path=Content.Icon.FontCharacter}"
                    Foreground="{Binding Path=Content.Icon.FontColor}"
                    FontSize="16"
                    MinWidth="20"
                    Margin="0" />
          <TextBlock Margin="4 0 0 0"
                     Text="{Binding Path=Content.Name, Mode=OneWay}" />
        </StackPanel>
      </muxc:TreeViewItem>
    </DataTemplate>

    <ui:FontFamilyConverter x:Key="FontFamilyConverter" />

    <local:ResourceTemplateSelector x:Key="ResourceTemplateSelector"
                                    FolderTemplate="{StaticResource FolderTemplate}"
                                    FileTemplate="{StaticResource FileTemplate}" />

    <!-- Add File MenuFlyout for toolbar button -->
    <MenuFlyout x:Name="AddFileMenuFlyout"
                Placement="Bottom">
      <MenuFlyoutItem Text="{x:Bind AddPythonScriptString}"
                      Tag="{x:Bind explorer:ResourceFormat.Python}"
                      Click="ToolbarAddFile_Click" />
      <MenuFlyoutItem Text="{x:Bind AddExcelString}"
                      Tag="{x:Bind explorer:ResourceFormat.Excel}"
                      Click="ToolbarAddFile_Click" />
      <MenuFlyoutItem Text="{x:Bind AddMarkdownString}"
                      Tag="{x:Bind explorer:ResourceFormat.Markdown}"
                      Click="ToolbarAddFile_Click" />
      <MenuFlyoutItem Text="{x:Bind AddWebAppString}"
                      Tag="{x:Bind explorer:ResourceFormat.WebApp}"
                      Click="ToolbarAddFile_Click" />
      <MenuFlyoutItem Text="{x:Bind AddTextFileString}"
                      Tag="{x:Bind explorer:ResourceFormat.Text}"
                      Click="ToolbarAddFile_Click" />
    </MenuFlyout>
  </UserControl.Resources>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- Project Name and Toolbar Row -->
    <Grid Grid.Row="0"
          Margin="8,4,8,4">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>

      <!-- Project Folder Name -->
      <Grid Grid.Column="0"
            VerticalAlignment="Center"
            IsHitTestVisible="False">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        <FontIcon Grid.Column="0"
                  FontFamily="{StaticResource SymbolThemeFontFamily}"
                  Glyph="&#xE8D5;"
                  FontSize="16"
                  Margin="0,0,6,0"
                  VerticalAlignment="Center"
                  Foreground="#FFCC40" />
        <TextBlock Grid.Column="1"
                   Text="{x:Bind ViewModel.ProjectFolderName, Mode=OneWay}"
                   VerticalAlignment="Center"
                   FontWeight="SemiBold"
                   TextTrimming="CharacterEllipsis" />
      </Grid>

      <!-- Toolbar Buttons -->
      <StackPanel x:Name="ToolbarPanel"
                  Grid.Column="1"
                  Orientation="Horizontal"
                  Spacing="0"
                  Opacity="0">
        <StackPanel.Resources>
          <!-- Button theme resources are overridden on the parent to give all child buttons the same hover behaviour -->
          <SolidColorBrush x:Key="ButtonBackground" Color="Transparent" />
          <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="{ThemeResource SystemListLowColor}" />
          <SolidColorBrush x:Key="ButtonBackgroundPressed" Color="{ThemeResource SystemListMediumColor}" />
          <SolidColorBrush x:Key="ButtonBorderBrush" Color="Transparent" />
          <SolidColorBrush x:Key="ButtonBorderBrushPointerOver" Color="Transparent" />
          <SolidColorBrush x:Key="ButtonBorderBrushPressed" Color="Transparent" />
        </StackPanel.Resources>
        <Button x:Name="AddFileButton"
                ToolTipService.ToolTip="{x:Bind AddFileTooltipString}"
                Padding="4"
                Flyout="{StaticResource AddFileMenuFlyout}">
          <FontIcon FontFamily="{StaticResource FluentSystemIconsFamily}"
                    Glyph="&#xE4DA;"
                    FontSize="20" />
        </Button>
        <Button x:Name="AddFolderButton"
                ToolTipService.ToolTip="{x:Bind AddFolderTooltipString}"
                Padding="4"
                Click="ToolbarAddFolder_Click">
          <FontIcon FontFamily="{StaticResource FluentSystemIconsFamily}"
                    Glyph="&#xE645;"
                    FontSize="20" />
        </Button>
        <!-- Not sure if this is really needed - add it back if anyone complains
        <Button x:Name="RefreshExplorerButton"
                ToolTipService.ToolTip="{x:Bind RefreshExplorerTooltipString}"
                Padding="4"
                Click="ToolbarRefreshExplorer_Click">
          <FontIcon FontFamily="{StaticResource FluentSystemIconsFamily}"
                    Glyph="&#xF06AE;"
                    FontSize="20" />
        </Button>
        -->
        <Button x:Name="CollapseFoldersButton"
                ToolTipService.ToolTip="{x:Bind CollapseFoldersTooltipString}"
                Padding="4"
                Click="ToolbarCollapseFolders_Click">
          <FontIcon FontFamily="{StaticResource FluentSystemIconsFamily}"
                    Glyph="&#xF418;"
                    FontSize="20" />
        </Button>
        <Button x:Name="ProjectSettingsButton"
                ToolTipService.ToolTip="{x:Bind ProjectSettingsTooltipString}"
                Padding="4"
                Click="ToolbarProjectSettings_Click">
          <FontIcon FontFamily="{StaticResource FluentSystemIconsFamily}"
                    Glyph="&#xF6AB;"
                    FontSize="20" />
        </Button>
      </StackPanel>
    </Grid>

    <!-- Resource Tree View -->
    <ScrollViewer Grid.Row="1"
                  VerticalScrollBarVisibility="Auto"
                  VerticalAlignment="Stretch"
                  ContextFlyout="{StaticResource ResourceContextMenu}">
      <muxc:TreeView x:Name="ResourcesTreeView"
                   ItemTemplateSelector="{StaticResource ResourceTemplateSelector}"
                   CanReorderItems="True"
                   SelectionMode="Single"
                   KeyDown="TreeView_KeyDown"
                   DragItemsCompleted="ResourcesTreeView_DragItemsCompleted"
                   AllowDrop="True"
                   DragOver="ResourcesTreeView_DragOver"
                   Drop="ResourcesTreeView_Drop"
                   SelectionChanged="ResourcesTreeView_SelectionChanged" />
    </ScrollViewer>
  </Grid>
</UserControl>
