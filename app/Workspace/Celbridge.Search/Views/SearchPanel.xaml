<UserControl
  x:Class="Celbridge.Search.Views.SearchPanel"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:local="using:Celbridge.Search.Views"
  xmlns:vm="using:Celbridge.Search.ViewModels"
  xmlns:controls="using:Celbridge.UserInterface.Views.Controls"
  xmlns:converters="using:Celbridge.UserInterface.Converters"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  GotFocus="UserControl_GotFocus"
  PointerPressed="UserControl_PointerPressed">

  <UserControl.Resources>
    <converters:ExpanderGlyphConverter x:Key="ExpandCollapseGlyphConverter"/>
  </UserControl.Resources>

  <Grid VerticalAlignment="Stretch"
        Background="Transparent">

    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <!-- Panel Header -->
    <controls:PanelHeader Grid.Row="0"
                          Panel="Search"
                          VisibilityFlag="Primary"
                          Title="{x:Bind ViewModel.TitleText, Mode=OneWay}"/>

    <!-- Search Input -->
    <Grid Grid.Row="1"
          Padding="12,8,12,4">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="Auto"/>
      </Grid.ColumnDefinitions>

      <TextBox x:Name="SearchTextBox"
               Grid.Column="0"
               Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
               PlaceholderText="{x:Bind ViewModel.SearchPlaceholder, Mode=OneWay}"
               KeyDown="SearchTextBox_KeyDown"/>

      <!-- Progress ring overlay -->
      <ProgressRing IsActive="{x:Bind ViewModel.IsSearching, Mode=OneWay}"
                    Width="16"
                    Height="16"
                    HorizontalAlignment="Right"
                    Margin="0,0,40,0"/>

      <!-- Search button -->
      <Button Grid.Column="1"
              Command="{x:Bind ViewModel.ExecuteSearchCommand}"
              Background="Transparent"
              BorderThickness="0"
              Margin="4,0,0,0"
              Padding="8,6"
              VerticalAlignment="Center"
              ToolTipService.ToolTip="{x:Bind ViewModel.SearchTooltip, Mode=OneWay}">
        <FontIcon Glyph="&#xE721;" FontSize="14"/>
      </Button>
    </Grid>

    <!-- Search Options -->
    <StackPanel Grid.Row="2"
                Orientation="Horizontal"
                Padding="12,4,48,8"
                Spacing="4"
                HorizontalAlignment="Right">
      <!-- Match Case toggle button -->
      <ToggleButton IsChecked="{x:Bind ViewModel.MatchCase, Mode=TwoWay}"
                    ToolTipService.ToolTip="{x:Bind ViewModel.MatchCaseTooltip, Mode=OneWay}"
                    Padding="8,6"
                    MinWidth="36"
                    MinHeight="32">
        <FontIcon Glyph="&#xE8E9;" FontSize="14"/>
      </ToggleButton>

      <!-- Whole Word toggle button -->
      <ToggleButton IsChecked="{x:Bind ViewModel.WholeWord, Mode=TwoWay}"
                    ToolTipService.ToolTip="{x:Bind ViewModel.WholeWordTooltip, Mode=OneWay}"
                    Padding="8,6"
                    MinWidth="36"
                    MinHeight="32">
        <TextBlock Text="ab" FontWeight="SemiBold"/>
      </ToggleButton>

      <!-- Collapse All button -->
      <Button Command="{x:Bind ViewModel.CollapseAllCommand}"
              ToolTipService.ToolTip="{x:Bind ViewModel.CollapseAllTooltip, Mode=OneWay}"
              IsEnabled="{x:Bind ViewModel.HasResults, Mode=OneWay}"
              Background="Transparent"
              BorderThickness="1"
              Padding="8,6"
              MinWidth="36"
              MinHeight="32">
        <FontIcon Glyph="&#xF165;" FontSize="14"/>
      </Button>
    </StackPanel>

    <!-- Results Section -->
    <Grid Grid.Row="3">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
      </Grid.RowDefinitions>

      <!-- Status Bar -->
      <Border Grid.Row="0"
              Padding="12,6"
              Visibility="{x:Bind ViewModel.HasResults, Mode=OneWay}">
        <TextBlock Text="{x:Bind ViewModel.StatusText, Mode=OneWay}"
                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
      </Border>

      <!-- No Results Message -->
      <TextBlock Grid.Row="1"
                 Text="{x:Bind ViewModel.NoResultsText, Mode=OneWay}"
                 Visibility="{x:Bind ViewModel.ShowNoResults, Mode=OneWay}"
                 HorizontalAlignment="Center"
                 Margin="0,12,0,0"
                 Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

      <!-- Results Tree -->
      <ScrollViewer Grid.Row="1"
                    Visibility="{x:Bind ViewModel.HasResults, Mode=OneWay}"
                    VerticalScrollBarVisibility="Auto"
                    HorizontalScrollBarVisibility="Disabled">
        <ItemsControl ItemsSource="{x:Bind ViewModel.FileResults, Mode=OneWay}"
                      Margin="0,4,0,0">
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="vm:SearchFileResultViewModel">
              <StackPanel Margin="0,0,0,4">
                <!-- File Header -->
                <Grid Margin="8,2,8,2"
                      Padding="4"
                      PointerPressed="FileHeader_PointerPressed"
                      Background="Transparent">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>

                  <!-- Expand/Collapse Icon -->
                  <FontIcon Grid.Column="0"
                            Glyph="{x:Bind IsExpanded, Mode=OneWay, Converter={StaticResource ExpandCollapseGlyphConverter}}"
                            FontSize="14"
                            Margin="0,0,4,0"
                            VerticalAlignment="Center"/>

                  <!-- File Icon -->
                  <controls:FileIcon Grid.Column="1"
                                     IconDefinition="{x:Bind FileIcon}"
                                     Size="16"
                                     MinWidth="20"
                                     Margin="0,0,4,0"
                                     VerticalAlignment="Center"/>

                  <!-- File Name -->
                  <TextBlock Grid.Column="2"
                             Text="{x:Bind FileName}"
                             FontWeight="SemiBold"
                             TextTrimming="CharacterEllipsis"
                             VerticalAlignment="Center"
                             ToolTipService.ToolTip="{x:Bind RelativePath}"/>

                  <!-- Match Count Badge -->
                  <Border Grid.Column="3"
                          Background="{ThemeResource AccentFillColorDefaultBrush}"
                          CornerRadius="8"
                          Padding="6,1,6,2"
                          Margin="4,0,0,0"
                          VerticalAlignment="Center">
                    <TextBlock Text="{x:Bind MatchCount}"
                               Foreground="White"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Center"/>
                  </Border>
                </Grid>

                <!-- Match Lines -->
                <ItemsControl ItemsSource="{x:Bind Matches}"
                              Visibility="{x:Bind IsExpanded, Mode=OneWay}"
                              Margin="0,0,8,0">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:SearchMatchLineViewModel">
                      <Grid Padding="4,2"
                            Margin="0,1"
                            PointerPressed="MatchLine_PointerPressed"
                            Background="Transparent">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="36"/>
                          <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Line Number -->
                        <TextBlock Grid.Column="0"
                                   Text="{x:Bind LineNumber}"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   HorizontalAlignment="Right"
                                   Margin="0,0,8,0"/>

                        <!-- Line Text with Highlighted Match -->
                        <TextBlock Grid.Column="1"
                                   TextTrimming="CharacterEllipsis"
                                   ToolTipService.ToolTip="{x:Bind LineText}">
                          <Run Text="{x:Bind TextBeforeMatch}"/><Run Text="{x:Bind MatchedText}" 
                               Foreground="{ThemeResource SearchMatchHighlightBrush}"/><Run Text="{x:Bind TextAfterMatch}"/>
                        </TextBlock>
                      </Grid>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </StackPanel>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>
    </Grid>
  </Grid>
</UserControl>
