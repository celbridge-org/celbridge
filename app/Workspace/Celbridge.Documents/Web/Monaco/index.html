<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet"
          data-name="vs/editor/editor.main"
          href="./min/vs/editor/editor.main.css" />
    <style>
        html, body { height: 100%; margin: 0; }
        #container {
            height: 100vh;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="container"></div>

    <!-- Step 1: Load Monaco Editor AMD Loader -->
    <script src="./min/vs/loader.js"></script>

    <script>
        // Monaco Editor initialization for Celbridge WebView integration
        // IIFE prevents polluting global scope with internal functions
        (function() {
            'use strict';

            // Configure AMD loader and load Monaco
            require.config({ paths: { 'vs': './min/vs' } });
            require(['vs/editor/editor.main'], function() {
                initializeEditor();
            });

            function initializeEditor() {
                window.editor = monaco.editor.create(document.getElementById('container'), {
                    language: 'plaintext',
                    automaticLayout: true,
                    theme: window.theme || 'vs-light',
                    minimap: { autohide: true },
                    wordWrap: 'on'
                });

                setupLineEndings();
                setupContentChangeListener();
                setupWebViewCommunication();
                setupKeyboardShortcuts();

                postWebViewMessage('editor_ready');
            }

            function setupLineEndings() {
                const isWindows = /windows/i.test(
                    navigator.userAgentData?.platform || 
                    navigator.platform || 
                    navigator.userAgent
                );
                
                const model = window.editor.getModel();
                model.setEOL(isWindows 
                    ? monaco.editor.EndOfLineSequence.CRLF 
                    : monaco.editor.EndOfLineSequence.LF
                );
            }

            function setupContentChangeListener() {
                window.editor.getModel().onDidChangeContent((event) => {
                    if (window.isWebView && window.initializedTextData) {
                        postWebViewMessage('did_change_content');
                    }
                });
            }

            // WebView communication for Uno Platform
            function setupWebViewCommunication() {
                if (!window.isWebView) {
                    return;
                }

                if (window.chrome && typeof chrome.webview !== 'undefined') {
                    window.chrome.webview.addEventListener('message', event => {
                        handleWebViewMessage(event.data);
                    });
                }
                else if (window.unoWebView) {
                    window.unoWebViewReceiveMessage = function(data) {
                        handleWebViewMessage(data);
                    };
                }
                else if (window.webkit && typeof webkit.messageHandlers !== 'undefined') {
                    window.webkit.messageHandlers.unoWebViewReceiveMessage = function(data) {
                        handleWebViewMessage(data);
                    };
                }
            }

            function handleWebViewMessage(data) {
                setTextData(data);
            }

            function postWebViewMessage(message) {
                if (!window.isWebView) {
                    return;
                }

                try {
                    if (window.chrome && typeof chrome.webview !== 'undefined') {
                        chrome.webview.postMessage(message);
                    }
                    else if (window.unoWebView) {
                        unoWebView.postMessage(JSON.stringify(message));
                    }
                    else if (window.webkit && typeof webkit.messageHandlers !== 'undefined') {
                        webkit.messageHandlers.unoWebView.postMessage(JSON.stringify(message));
                    }
                }
                catch (ex) {
                    console.error('Failed to send message to WebView host:', ex);
                }
            }

            function setupKeyboardShortcuts() {
                window.addEventListener('keydown', function(event) {
                    // F11 toggles full screen layout
                    if (event.key === 'F11') {
                        event.preventDefault();
                        if (window.chrome && window.chrome.webview) {
                            window.chrome.webview.postMessage('toggle_layout');
                        }
                    }
                });
            }

            // Public API - called by Uno Platform via ExecuteScriptAsync
            window.getTextData = function() {
                return window.editor.getValue();
            };

            window.setTextData = function(text) {
                if (!window.isWebView) {
                    return;
                }
                window.editor.setValue(text);
                window.initializedTextData = true;
            };

            window.setLanguage = function(language) {
                monaco.editor.setModelLanguage(window.editor.getModel(), language);
            };

        })();
    </script>
</body>
</html>
