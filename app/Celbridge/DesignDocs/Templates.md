# Template Management Architecture

## Overview

This document describes an approach to manage Celbridge project templates (Empty, Examples, etc.) directly within Visual Studio, eliminating the need for external scripts to generate template zip files.

## Current Problems

### 1. External Template Management

Currently, template zip files must be:
- Created manually or via external scripts
- Updated outside of Visual Studio
- Committed as binary zip files to source control

### 2. Poor Developer Experience

- Cannot edit template files directly in Visual Studio
- No IntelliSense or syntax highlighting for template content
- Changes require running external scripts before testing
- Difficult to track changes to template content in source control

### 3. Template Asset Loading

The current implementation in `Project.CreateProjectAsync()` loads templates from embedded assets:
```csharp
var sourceZipFile = await StorageFile.GetFileFromApplicationUriAsync(new Uri(template.TemplateAssetPath));
```

Where `TemplateAssetPath` is something like `ms-appx:///Assets/Templates/Empty.zip`.

---

## Proposed Architecture

### Solution Structure

```
Celbridge.sln
├── Templates/                              (Solution Folder)
│   ├── Celbridge.Templates.Empty/
│   │   ├── Celbridge.Templates.Empty.csproj
│   │   ├── template.celbridge              (Template project file)
│   │   ├── readme.md
│   │   └── ... (other template files)
│   └── Celbridge.Templates.Examples/
│       ├── Celbridge.Templates.Examples.csproj
│       ├── examples.celbridge
│       ├── readme.md
│       ├── 01_markdown/
│       │   ├── readme.md
│       │   └── images/
│       ├── 02_webapps/
│       ├── 03_hello_world/
│       ├── 04_data_import/
│       ├── 05_fake_data/
│       └── 06_data_cleaning/
└── app/
    └── Celbridge/
        └── Assets/
            └── Templates/
                ├── Empty.zip               (Generated by build)
                └── Examples.zip            (Generated by build)
```

### Template Project Structure

Each template is an SDK-style project that:
1. Contains the template source files as `Content` items
2. Does not produce a .NET assembly (no code compilation)
3. Has a custom MSBuild target to zip files during build
4. Outputs the zip to `Celbridge/Assets/Templates/`

---

## Implementation

### 1. Template Project File (.csproj)

**Location**: `Templates/Celbridge.Templates.Empty/Celbridge.Templates.Empty.csproj`

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    
    <!-- This is not a code project - disable all compilation -->
    <EnableDefaultItems>false</EnableDefaultItems>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <CopyBuildOutputToOutputDirectory>false</CopyBuildOutputToOutputDirectory>
    <CopyOutputSymbolsToOutputDirectory>false</CopyOutputSymbolsToOutputDirectory>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <GenerateTargetFrameworkAttribute>false</GenerateTargetFrameworkAttribute>
    
    <!-- Template metadata -->
    <TemplateName>Empty</TemplateName>
    <TemplateOutputDir>$(MSBuildThisFileDirectory)..\..\app\Celbridge\Assets\Templates</TemplateOutputDir>
  </PropertyGroup>

  <!-- Include all template files as Content for visibility in Solution Explorer -->
  <ItemGroup>
    <Content Include="**\*" Exclude="bin\**;obj\**;*.csproj;*.csproj.user;.vs\**" />
  </ItemGroup>

  <!-- Custom build target to zip template files -->
  <Target Name="ZipTemplate" AfterTargets="Build">
    <PropertyGroup>
      <TemplateSourceDir>$(MSBuildProjectDirectory)</TemplateSourceDir>
      <TemplateZipPath>$(TemplateOutputDir)\$(TemplateName).zip</TemplateZipPath>
    </PropertyGroup>

    <!-- Ensure output directory exists -->
    <MakeDir Directories="$(TemplateOutputDir)" />

    <!-- Delete old zip if it exists -->
    <Delete Files="$(TemplateZipPath)" Condition="Exists('$(TemplateZipPath)')" />

    <!-- Create zip from template source directory -->
    <ZipDirectory
      SourceDirectory="$(TemplateSourceDir)"
      DestinationFile="$(TemplateZipPath)"
      Overwrite="true" />

    <Message Text="Created template: $(TemplateZipPath)" Importance="high" />
  </Target>

  <!-- Clean target to remove generated zip -->
  <Target Name="CleanTemplate" AfterTargets="Clean">
    <PropertyGroup>
      <TemplateZipPath>$(TemplateOutputDir)\$(TemplateName).zip</TemplateZipPath>
    </PropertyGroup>
    <Delete Files="$(TemplateZipPath)" Condition="Exists('$(TemplateZipPath)')" />
    <Message Text="Removed template: $(TemplateZipPath)" Importance="high" />
  </Target>

</Project>
```

### 2. Examples Template Project

**Location**: `Templates/Celbridge.Templates.Examples/Celbridge.Templates.Examples.csproj`

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    
    <!-- This is not a code project - disable all compilation -->
    <EnableDefaultItems>false</EnableDefaultItems>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <CopyBuildOutputToOutputDirectory>false</CopyBuildOutputToOutputDirectory>
    <CopyOutputSymbolsToOutputDirectory>false</CopyOutputSymbolsToOutputDirectory>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <GenerateTargetFrameworkAttribute>false</GenerateTargetFrameworkAttribute>
    
    <!-- Template metadata -->
    <TemplateName>Examples</TemplateName>
    <TemplateOutputDir>$(MSBuildThisFileDirectory)..\..\app\Celbridge\Assets\Templates</TemplateOutputDir>
  </PropertyGroup>

  <!-- Include all template files as Content for visibility in Solution Explorer -->
  <ItemGroup>
    <Content Include="**\*" Exclude="bin\**;obj\**;*.csproj;*.csproj.user;.vs\**" />
  </ItemGroup>

  <!-- Custom build target to zip template files -->
  <Target Name="ZipTemplate" AfterTargets="Build">
    <PropertyGroup>
      <TemplateSourceDir>$(MSBuildProjectDirectory)</TemplateSourceDir>
      <TemplateZipPath>$(TemplateOutputDir)\$(TemplateName).zip</TemplateZipPath>
    </PropertyGroup>

    <MakeDir Directories="$(TemplateOutputDir)" />
    <Delete Files="$(TemplateZipPath)" Condition="Exists('$(TemplateZipPath)')" />
    <ZipDirectory
      SourceDirectory="$(TemplateSourceDir)"
      DestinationFile="$(TemplateZipPath)"
      Overwrite="true" />

    <Message Text="Created template: $(TemplateZipPath)" Importance="high" />
  </Target>

  <Target Name="CleanTemplate" AfterTargets="Clean">
    <PropertyGroup>
      <TemplateZipPath>$(TemplateOutputDir)\$(TemplateName).zip</TemplateZipPath>
    </PropertyGroup>
    <Delete Files="$(TemplateZipPath)" Condition="Exists('$(TemplateZipPath)')" />
  </Target>

</Project>
```

### 3. Shared Template Props (Optional)

To avoid duplication, create a shared props file.

**Location**: `Templates/Directory.Build.props`

```xml
<Project>
  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    
    <!-- Disable all compilation - these are content-only projects -->
    <EnableDefaultItems>false</EnableDefaultItems>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <CopyBuildOutputToOutputDirectory>false</CopyBuildOutputToOutputDirectory>
    <CopyOutputSymbolsToOutputDirectory>false</CopyOutputSymbolsToOutputDirectory>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <GenerateTargetFrameworkAttribute>false</GenerateTargetFrameworkAttribute>
    
    <!-- Common output directory for all templates -->
    <TemplateOutputDir>$(MSBuildThisFileDirectory)..\app\Celbridge\Assets\Templates</TemplateOutputDir>
  </PropertyGroup>

  <!-- Include all template files as Content -->
  <ItemGroup>
    <Content Include="**\*" Exclude="bin\**;obj\**;*.csproj;*.csproj.user;.vs\**" />
  </ItemGroup>
</Project>
```

**Location**: `Templates/Directory.Build.targets`

```xml
<Project>
  <Target Name="ZipTemplate" AfterTargets="Build">
    <PropertyGroup>
      <TemplateSourceDir>$(MSBuildProjectDirectory)</TemplateSourceDir>
      <TemplateZipPath>$(TemplateOutputDir)\$(TemplateName).zip</TemplateZipPath>
    </PropertyGroup>

    <MakeDir Directories="$(TemplateOutputDir)" />
    <Delete Files="$(TemplateZipPath)" Condition="Exists('$(TemplateZipPath)')" />
    <ZipDirectory
      SourceDirectory="$(TemplateSourceDir)"
      DestinationFile="$(TemplateZipPath)"
      Overwrite="true" />

    <Message Text="Created template: $(TemplateZipPath)" Importance="high" />
  </Target>

  <Target Name="CleanTemplate" AfterTargets="Clean">
    <PropertyGroup>
      <TemplateZipPath>$(TemplateOutputDir)\$(TemplateName).zip</TemplateZipPath>
    </PropertyGroup>
    <Delete Files="$(TemplateZipPath)" Condition="Exists('$(TemplateZipPath)')" />
  </Target>
</Project>
```

With shared props/targets, individual template projects become minimal:

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TemplateName>Empty</TemplateName>
  </PropertyGroup>
</Project>
```

### 4. Main Project Dependencies

Add project references to `Celbridge.csproj` to ensure templates build before the main app:

```xml
<!-- Template project references - ensures templates are zipped before build -->
<ItemGroup>
  <ProjectReference Include="..\..\Templates\Celbridge.Templates.Empty\Celbridge.Templates.Empty.csproj">
    <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
    <SkipGetTargetFrameworkProperties>true</SkipGetTargetFrameworkProperties>
  </ProjectReference>
  <ProjectReference Include="..\..\Templates\Celbridge.Templates.Examples\Celbridge.Templates.Examples.csproj">
    <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
    <SkipGetTargetFrameworkProperties>true</SkipGetTargetFrameworkProperties>
  </ProjectReference>
</ItemGroup>
```

### 5. Asset Inclusion

Ensure the generated zip files are included as assets in `Celbridge.csproj`:

```xml
<ItemGroup>
  <Content Include="Assets\Templates\*.zip">
    <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
  </Content>
</ItemGroup>
```

### 6. .gitignore Update

Add to `.gitignore` to exclude generated zips (since they're built from source):

```
# Generated template zips
app/Celbridge/Assets/Templates/*.zip
```

Alternatively, keep the zips in source control if you want the repo to be buildable without running template projects first.

---

## Template Content Guidelines

### Template Project File Placeholders

The `.celbridge` file inside each template should use placeholders that get replaced during project creation:

```toml
[celbridge]
version = "<application-version>"

[project]
name = "My Project"
requires-python = "<python-version>"
```

These placeholders are replaced in `Project.CreateProjectAsync()` (or `ProjectTemplateService.CreateFromTemplateAsync()` after refactoring):

```csharp
projectFileContents = projectFileContents
    .Replace("<application-version>", appVersion)
    .Replace("<python-version>", ProjectConstants.DefaultPythonVersion);
```

### Template Project File Naming

The `ProjectTemplate.TemplateProjectFileName` property must match the actual `.celbridge` filename in the template:

| Template | TemplateProjectFileName |
|----------|------------------------|
| Empty    | `template.celbridge`   |
| Examples | `examples.celbridge`   |

---

## Visual Studio Setup

### 1. Create Solution Folder

1. Right-click solution → **Add** → **New Solution Folder**
2. Name it "Templates"

### 2. Add Template Projects

1. Right-click "Templates" folder → **Add** → **Existing Project**
2. Select each template `.csproj` file

### 3. Build Configuration (Optional)

If you don't want templates to build on every build:

1. Right-click solution → **Configuration Manager**
2. Uncheck "Build" for template projects in Release configuration
3. Keep them checked in Debug for active development

Alternatively, add a condition to the ZipTemplate target:

```xml
<Target Name="ZipTemplate" AfterTargets="Build" Condition="'$(Configuration)' == 'Debug' Or '$(ForceTemplateZip)' == 'true'">
```

---

## Benefits

| Benefit | Description |
|---------|-------------|
| **Edit in Visual Studio** | All template files are visible and editable in Solution Explorer |
| **Syntax Support** | IntelliSense, syntax highlighting for `.md`, `.py`, `.toml`, etc. |
| **Automatic Zipping** | Build process handles zip creation automatically |
| **Source Control** | Template source files are tracked; changes are visible in diffs |
| **Build Validation** | Build fails if template content is invalid or missing |
| **Clean Separation** | Templates are separate projects with clear boundaries |
| **Easy Maintenance** | Add/remove/modify templates without external tools |

---

## Migration Steps

### Phase 1: Create Template Projects

1. Create `Templates/` directory in repository root
2. Create `Celbridge.Templates.Empty/` project with existing Empty template content
3. Create `Celbridge.Templates.Examples/` project with existing Examples template content
4. Add shared `Directory.Build.props` and `Directory.Build.targets`

### Phase 2: Update Solution

1. Add "Templates" solution folder
2. Add template projects to solution
3. Add project references from `Celbridge.csproj`
4. Update asset inclusion in `Celbridge.csproj`

### Phase 3: Verify and Clean Up

1. Build solution and verify templates are created
2. Test creating new projects from both templates
3. Remove old manually-created zip files from source control
4. Update `.gitignore` if excluding generated zips
5. Remove any external template generation scripts

---

## Future Enhancements

### 1. Template Validation Target

Add a target to validate template content during build:

```xml
<Target Name="ValidateTemplate" BeforeTargets="ZipTemplate">
  <!-- Check that required files exist -->
  <Error Condition="!Exists('$(TemplateSourceDir)\$(TemplateProjectFileName)')"
         Text="Template must contain $(TemplateProjectFileName)" />
</Target>
```

### 2. Additional Templates

To add a new template:

1. Create new project folder under `Templates/`
2. Add minimal `.csproj` with `<TemplateName>` property
3. Add template content files
4. Add to solution and project references
5. Register template in `ProjectTemplate` definitions

### 3. Template Versioning

Consider adding version metadata to templates:

```xml
<PropertyGroup>
  <TemplateName>Empty</TemplateName>
  <TemplateVersion>1.0.0</TemplateVersion>
</PropertyGroup>
```

---

## Open Questions

1. Should generated `.zip` files be committed to source control for easier CI/CD, or always generated from source?
2. Should template projects have their own unit tests to validate content?
3. Should we support localized templates (different languages)?
4. How should large binary assets in templates (images, sample data) be handled?
